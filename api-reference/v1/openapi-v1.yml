openapi: 3.1.1
info:
  title: Metafy API
  version: v1
  contact:
    name: Metafy
    url: https://metafy.gg
    email: engineering@metafy.gg

servers:
  - url: https://metafy.gg/irk/api/v1
    description: API Endpoint

security:
  - authorizationCode: []
  - clientCredentials: []

# Tags for organizing endpoints into categories
tags:
  - name: User
    description: Operations related to the authenticated users profile information
  - name: Community
    description: Operations related to the authenticated users community
  - name: Content
    description: Operations related to the product offerings of the authenticated user
  - name: Purchases
    description: Operations for verifying purchases and subscriptions

paths:
  /me:
    get:
      tags:
        - User
      summary: Get Profile
      description: |
        This endpoint returns information about the authenticated account.
      operationId: getMe
      security:
        - authorizationCode: [profile]
        - clientCredentials: [profile]
      responses:
        '200':
          description: User profile successfully retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
              examples:
                success:
                  summary: Example user response
                  value:
                    user:
                      id: "12345"
                      slug: "pro-gamer"
                      name: "Pro Gamer"
                      email: "progamer@example.com"
                      partner: true
                      profile_image_url: "https://metafy.gg/img/profiles/progamer.jpg"
                      cover_image_url: "https://metafy.gg/img/covers/progamer.jpg"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /me/guides:
    get:
      tags:
        - Content
      summary: List Guides
      description: |
        This endpoint returns a list of guides that the authenticated account has published.
      operationId: getMyGuides
      security:
        - authorizationCode: [content]
        - clientCredentials: [content]
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
      responses:
        '200':
          description: Guides successfully retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  guides:
                    type: array
                    items:
                      $ref: '#/components/schemas/Guide'
                  meta:
                    type: object
                    properties:
                      pagination:
                        $ref: '#/components/schemas/Pagination'
              examples:
                success:
                  summary: Example guides response
                  value:
                    guides:
                      - id: "guide-123"
                        published_at: "2025-01-15T14:30:00Z"
                        name: "Mastering Advanced Techniques"
                        description: "A comprehensive guide to advanced gameplay mechanics"
                    meta:
                      pagination:
                        current_page: 1
                        per_page: 100
                        total_pages: 1
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /me/community:
    get:
      tags:
        - Community
      summary: Get Community
      description: |
        This endpoint returns information about the commmunity owned by the authenticated account.
      operationId: getMyCommunity
      security:
        - authorizationCode: [community]
        - clientCredentials: [community]
      responses:
        '200':
          description: Community information successfully retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  community:
                    $ref: '#/components/schemas/Community'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /me/community/subscribers:
    get:
      tags:
        - Community
      summary: List Community Subscribers
      description: |
        This endpoint returns a paginated list of active subscribers to the authenticated account's community.
      operationId: getMyCommunitySubscribers
      security:
        - authorizationCode: [community]
        - clientCredentials: [community]
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
      responses:
        '200':
          description: Subscribers successfully retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  subscribers:
                    type: array
                    items:
                      $ref: '#/components/schemas/Subscriber'
                  meta:
                    type: object
                    properties:
                      pagination:
                        $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /me/community/members:
    get:
      tags:
        - Community
      summary: List Community Members
      description: |
        This endpoint returns a paginated list of all members of the authenticated account's community.
      operationId: getCommunityMembers
      security:
        - authorizationCode: [community]
        - clientCredentials: [community]
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
      responses:
        '200':
          description: Members successfully retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  members:
                    type: array
                    items:
                      $ref: '#/components/schemas/Member'
                  meta:
                    type: object
                    properties:
                      pagination:
                        $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /me/community/members/{userId}:
    get:
      tags:
        - Community
      summary: Get Community Member
      description: |
        This endpoint returns information on a community member if they exist.
      operationId: getCommunityMember
      security:
        - authorizationCode: [community]
        - clientCredentials: [community]
      parameters:
        - name: userId
          in: path
          required: true
          description: ID of the user to check
          schema:
            type: string
      responses:
        '200':
          description: User is a member of the community
          content:
            application/json:
              schema:
                type: object
                properties:
                  member:
                    $ref: '#/components/schemas/Member'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /me/purchases/guides/{guideId}:
    get:
      tags:
        - Purchases
      summary: Purchased Guide
      description: |
        This endpoint determines if the authenticated account has access to read this guide.

        This could be from a purchase of the guide or from an active subscription benefit.
      operationId: checkGuideAccess
      security:
        - authorizationCode: [purchases]
        - clientCredentials: [purchases]
      parameters:
        - name: guideId
          in: path
          required: true
          description: ID of the guide to check access
          schema:
            type: string
      responses:
        '200':
          description: User has access to this guide
          content:
            application/json:
              schema:
                type: object
                properties:
                  guide:
                    $ref: '#/components/schemas/GuidePurchase'
              examples:
                hasAccess:
                  summary: User has access
                  value:
                    guide:
                      has_access: true
                noAccess:
                  summary: User does not have access
                  value:
                    guide:
                      has_access: false
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /me/purchases/communities/{communityId}:
    get:
      tags:
        - Purchases
      summary: Purchased Subscription
      description: |
        This endpoint determines if the authenticated account has an active subscription to this community.
      operationId: checkCommunitySubscription
      security:
        - authorizationCode: [purchases]
        - clientCredentials: [purchases]
      parameters:
        - name: communityId
          in: path
          required: true
          description: ID of the community to check subscription
          schema:
            type: string
      responses:
        '200':
          description: User is subscribed to this community
          content:
            application/json:
              schema:
                type: object
                properties:
                  community:
                    $ref: '#/components/schemas/CommunitySubscription'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    clientCredentials:
      type: oauth2
      description: |
        This API uses OAuth 2 with the client credentials flow.
      flows:
        clientCredentials:
          tokenUrl: https://metafy.gg/irk/oauth/token
          scopes:
            profile: Access to the users basic profile information including email
            community: Access to users community, including member and subscriber details
            content: Access to products offered by the user on Metafy
            purchases: Verify purchases of the user
    authorizationCode:
      type: oauth2
      description: |
        This API uses OAuth 2 with the authorization code flow.
      flows:
        authorizationCode:
          authorizationUrl: https://metafy.gg/auth/authorize
          tokenUrl: https://metafy.gg/irk/oauth/token
          refreshUrl: https://metafy.gg/irk/oauth/token
          scopes:
            profile: Access to the users basic profile information including email
            community: Access to users community, including member and subscriber details
            content: Access to products offered by the user on Metafy
            purchases: Verify purchases of the user

  parameters:
    PageParam:
      name: page
      in: query
      description: Page number for pagination
      schema:
        type: integer
        minimum: 1
        default: 1
      
    PerPageParam:
      name: per_page
      in: query
      description: Number of items per page
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 100

  responses:
    Unauthorized:
      description: Authentication credentials are missing or invalid
    Forbidden:
      description: You do not have permission to access this resource
    NotFound:
      description: The resource was not found

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier of the user
        slug:
          type: string
          description: URL slug of the user
        name:
          type: string
          description: Display name of the user
        email:
          type: string
          format: email
          description: Email of the user
        partner:
          type: boolean
          description: Whether the user is a Metafy Partner or not
        profile_image_url:
          type: string
          format: uri
          description: URL to the profile image of the user
        cover_image_url:
          type: string
          format: uri
          nullable: true
          description: URL to the cover image of the user

    Community:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier of the community
        title:
          type: string
          description: Name of the community
        description:
          type: string
          description: Description of the community
        logo_url:
          type: string
          format: uri
          nullable: true
          description: URL to the logo image of the community
        cover_url:
          type: string
          format: uri
          nullable: true
          description: URL to the cover image of the community
        url:
          type: string
          format: uri
          description: URL to the community on Metafy
        tiers:
          type: array
          description: List of tiers offered by the community
          items:
            type: object
            properties:
              id:
                type: string
                description: Unique identifier of the tier
              name:
                type: string
                description: Name of the tier
              description:
                type: string
                description: Description of the tier
              cover_url:
                type: string
                format: uri
                nullable: true
                description: URL of the cover image for the tier

    Guide:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the guide
        published_at:
          type: string
          format: date-time
          description: When the guide was published
        name:
          type: string
          description: Name of the guide
        description:
          type: string
          description: Description of the guide

    Subscriber:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier of the subscription
        subscribed_at:
          type: string
          format: date-time
          description: When the user subscribed to the community
        user_id:
          type: string
          description: Unique identifier of the user
        community_id:
          type: string
          description: Unique identifier of the community
        tier_id:
          type: string
          description: Unique identifier of the tier

    Member:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier of the member
        role:
          type: string
          description: Role of the member within the community
          enum: [admin, moderator, member]
        joined_at:
          type: string
          format: date-time
          description: When the user joined the community
        user_id:
          type: string
          description: Unique identifier of the user
        community_id:
          type: string
          description: Unique identifier of the community

    GuidePurchase:
      type: object
      properties:
        has_access:
          type: boolean
          description: Whether the user has access to this guide

    CommunitySubscription:
      type: object
      properties:
        has_access:
          type: boolean
          description: Whether the user is a subscriber to this community
        tier_id:
          type: string
          nullable: true
          description: Unique identifier of the tier

    Pagination:
      type: object
      properties:
        current_page:
          type: integer
          description: The current page
        per_page:
          type: integer
          description: Number of items per page requested
        total_pages:
          type: integer
          description: The total number of pages
